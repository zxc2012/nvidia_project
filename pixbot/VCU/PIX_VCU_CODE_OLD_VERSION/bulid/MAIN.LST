C166 COMPILER V7.00, MAIN                                                                  04/01/2020 13:21:46 PAGE 1   


C166 COMPILER V7.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN MAIN.OBJ
COMPILER INVOKED BY: H:\KEILC166\C166\BIN\C166.EXE MAIN.c MODV2 BROWSE MODV2 DEBUG

 stmt lvl     source

    1         //****************************************************************************
    2         // @Module        Project Settings
    3         // @Filename      MAIN.c
    4         // @Project       tiaoshi.dav
    5         //----------------------------------------------------------------------------
    6         // @Controller    Infineon XC2267M-104F80
    7         //
    8         // @Compiler      Keil
    9         //
   10         // @Codegenerator 2.0
   11         //
   12         // @Description   This file contains the project initialization function.
   13         //
   14         //----------------------------------------------------------------------------
   15         // @Date          2020/1/14 16:27:45
   16         //
   17         //****************************************************************************
   18         
   19         // USER CODE BEGIN (MAIN_General,1)
   20         
   21         // USER CODE END
   22         
   23         
   24         
   25         //****************************************************************************
   26         // @Project Includes
   27         //****************************************************************************
   28         
   29         #include "MAIN.h"
   30         
   31         // USER CODE BEGIN (MAIN_General,2)
   32         #include "vehicle_control.h"
   33         #include "steering.h"
   34         #include "remote.h"
   35         #include "pid_controler.h"
   36         #include "breaking_control.h"
   37         
   38         // USER CODE END
   39         
   40         
   41         //****************************************************************************
   42         // @Macros
   43         //****************************************************************************
   44         
   45         // USER CODE BEGIN (MAIN_General,3)
   46         
   47         // USER CODE END
   48         
   49         
   50         //****************************************************************************
   51         // @Defines
   52         //****************************************************************************
   53         
   54         // USER CODE BEGIN (MAIN_General,4)
   55         extern struct remote_receive remote_re; 
C166 COMPILER V7.00, MAIN                                                                  04/01/2020 13:21:46 PAGE 2   

   56         extern struct error_code vehicle_ec;
   57         extern struct vehicle vehicle_rcv;
   58         extern struct self_driving auto_cmd;
   59         extern int time_out_remote;
   60         //extern int delay_time; 
   61         int delay_time;
   62         extern int hand_break_mark,time_hand_break,time_auto_hand_break; //ÊÖÉ²±êÖ¾Î»ºÍÊÖÉ²¼ÆÊ±
   63         
   64         // USER CODE END
   65         
   66         
   67         //****************************************************************************
   68         // @Typedefs
   69         //****************************************************************************
   70         
   71         // USER CODE BEGIN (MAIN_General,5)
   72         
   73         // USER CODE END
   74         
   75         
   76         //****************************************************************************
   77         // @Imported Global Variables
   78         //****************************************************************************
   79         
   80         // USER CODE BEGIN (MAIN_General,6)
   81         
   82         // USER CODE END
   83         
   84         
   85         //****************************************************************************
   86         // @Global Variables
   87         //****************************************************************************
   88         
   89         // USER CODE BEGIN (MAIN_General,7)
   90         
   91         // USER CODE END
   92         
   93         
   94         //****************************************************************************
   95         // @External Prototypes
   96         //****************************************************************************
   97         
   98         // USER CODE BEGIN (MAIN_General,8)
   99         
  100         // USER CODE END
  101         
  102         
  103         //****************************************************************************
  104         // @Prototypes Of Local Functions
  105         //****************************************************************************
  106         
  107         // USER CODE BEGIN (MAIN_General,9)
  108         
  109         // ¿ÂÄ¬µç¶¯ ´Ë´¦¶¨ÒåÑÓÊ±º¯Êý
  110         void delay(int time)
  111         {
  112  1              unsigned int i;
  113  1              for(i=0;i<time;i++)
  114  1              {
  115  2                      _nop_();
  116  2                      _nop_();
  117  2                      _nop_();
C166 COMPILER V7.00, MAIN                                                                  04/01/2020 13:21:46 PAGE 3   

  118  2              }
  119  1      } 
  120         
  121         void delay_100ms(int time)
  122         {
  123  1              
  124  1              delay_time = 0;
  125  1              while (delay_time < time){SPI_Control();}
  126  1                      
  127  1      }
  128         
  129         // ¿ÂÄ¬µç¶¯ ´Ë´¦¶¨Òå¿ª¹ØÁ¿×´Ì¬º¯Êý
  130         void Switch_State(void)
  131         {
  132  1              //ST[0]µÄ×´Ì¬£º1£¨ÓÐÐ§£©»òÕß0£¨ÎÞÐ§£©¡£8Î»´ÓµÍµ½¸ß¶ÔÓ¦SP0-SP7.¹Ü½Å¸ßµçÆ½Ê±ÓÐÐ§¡£
  133  1      
  134  1              if(P7_IN_P2==0)                         //SP0
  135  1              ST[0]=ST[0]|0x01;
  136  1              else
  137  1              ST[0]=ST[0]&0xfe;
  138  1      
  139  1              if(P7_IN_P1==0)                         //SP1
  140  1              ST[0]=ST[0]|0x02;
  141  1              else
  142  1              ST[0]=ST[0]&0xfd;
  143  1      
  144  1              if(P6_IN_P1==0)                         //SP2
  145  1              ST[0]=ST[0]|0x04;
  146  1              else
  147  1              ST[0]=ST[0]&0xfb;
  148  1      
  149  1              if(P6_IN_P2==0)                         //SP3
  150  1              ST[0]=ST[0]|0x08;
  151  1              else
  152  1              ST[0]=ST[0]&0xf7;
  153  1      
  154  1              if(P5_IN_P3==0)                         //SP4
  155  1              ST[0]=ST[0]|0x10;
  156  1              else
  157  1              ST[0]=ST[0]&0xef;
  158  1      
  159  1              if(P5_IN_P5==0)                         //SP5
  160  1              ST[0]=ST[0]|0x20;
  161  1              else
  162  1              ST[0]=ST[0]&0xdf;
  163  1      
  164  1              if(P5_IN_P8==0)                         //SP6
  165  1              ST[0]=ST[0]|0x40;
  166  1              else
  167  1              ST[0]=ST[0]&0xbf;
  168  1      
  169  1              if(P5_IN_P9==0)                         //SP7
  170  1              ST[0]=ST[0]|0x80;
  171  1              else
  172  1              ST[0]=ST[0]&0x7f;
  173  1      
  174  1          //ST[1]µÄ×´Ì¬£º1£¨ÓÐÐ§£©»òÕß0£¨ÎÞÐ§£©¡£8Î»´ÓµÍµ½¸ß¶ÔÓ¦SG0-SG7.¹Ü½ÅµÍµçÆ½Ê±ÓÐÐ§¡£
  175  1      
  176  1              if(P5_IN_P10==0)                        //SG0
  177  1              ST[1]=ST[1]|0x01;
  178  1              else
  179  1              ST[1]=ST[1]&0xfe;
C166 COMPILER V7.00, MAIN                                                                  04/01/2020 13:21:46 PAGE 4   

  180  1      
  181  1              if(P5_IN_P11==0)                        //SG1
  182  1              ST[1]=ST[1]|0x02;
  183  1              else
  184  1              ST[1]=ST[1]&0xfd;
  185  1      
  186  1              if(P5_IN_P13==0)                        //SG2
  187  1              ST[1]=ST[1]|0x04;
  188  1              else
  189  1              ST[1]=ST[1]&0xfb;
  190  1      
  191  1              if(P5_IN_P15==0)                        //SG3
  192  1              ST[1]=ST[1]|0x08;
  193  1              else
  194  1              ST[1]=ST[1]&0xf7;
  195  1      
  196  1              if(P2_IN_P12==0)                        //SG4
  197  1              ST[1]=ST[1]|0x10;
  198  1              else
  199  1              ST[1]=ST[1]&0xef;
  200  1      
  201  1              if(P2_IN_P11==0)                        //SG5
  202  1              ST[1]=ST[1]|0x20;
  203  1              else
  204  1              ST[1]=ST[1]&0xdf;
  205  1      
  206  1              if(P2_IN_P2==0)                         //SG6
  207  1              ST[1]=ST[1]|0x40;
  208  1              else
  209  1              ST[1]=ST[1]&0xbf;
  210  1      
  211  1              if(P4_IN_P0==0)                          //SG7
  212  1              ST[1]=ST[1]|0x80;
  213  1              else
  214  1              ST[1]=ST[1]&0x7f;
  215  1      
  216  1          //ST[2]µÄ×´Ì¬£º1£¨ÓÐÐ§£©»òÕß0£¨ÎÞÐ§£©¡£7Î»´ÓµÍµ½¸ß¶ÔÓ¦SG8-SG14.¹Ü½ÅµÍµçÆ½Ê±ÓÐÐ§¡£
  217  1              if(P4_IN_P1==0)                         //SG8
  218  1              ST[2]=ST[2]|0x01;
  219  1              else
  220  1              ST[2]=ST[2]&0xfe;
  221  1      
  222  1              if(P2_IN_P8==0)                         //SG9
  223  1              ST[2]=ST[2]|0x02;
  224  1              else
  225  1              ST[2]=ST[2]&0xfd;
  226  1      
  227  1              if(P2_IN_P13==0)                        //SG10
  228  1              ST[2]=ST[2]|0x04;
  229  1              else
  230  1              ST[2]=ST[2]&0xfb;
  231  1      
  232  1              if(P2_IN_P10==0)                        //SG11
  233  1              ST[2]=ST[2]|0x08;
  234  1              else
  235  1              ST[2]=ST[2]&0xf7;
  236  1      
  237  1              if(P10_IN_P6==0)                        //SG12
  238  1              ST[2]=ST[2]|0x10;
  239  1              else
  240  1              ST[2]=ST[2]&0xef;
  241  1      
C166 COMPILER V7.00, MAIN                                                                  04/01/2020 13:21:46 PAGE 5   

  242  1              if(P10_IN_P7==0)                        //SG13
  243  1              ST[2]=ST[2]|0x20;
  244  1              else
  245  1              ST[2]=ST[2]&0xdf;
  246  1                                         
  247  1              if(P1_IN_P7==0)                         //SG14
  248  1              ST[2]=ST[2]|0x40;
  249  1              else
  250  1              ST[2]=ST[2]&0xbf;
  251  1                      
  252  1          //ST[3]µÄ×´Ì¬£º1£¨ÓÐÐ§£©»òÕß0£¨ÎÞÐ§£©¡£8Î»´ÓµÍµ½¸ß¶ÔÓ¦SP8-SP15.¹Ü½Å¸ßµçÆ½Ê±ÓÐÐ§¡£
  253  1      
  254  1              if(P10_IN_P9==0)                        //SP8
  255  1              ST[3]=ST[3]|0x01;
  256  1              else
  257  1              ST[3]=ST[3]&0xfe;
  258  1      
  259  1              if(P10_IN_P12==0)                       //SP9
  260  1              ST[3]=ST[3]|0x02;
  261  1              else
  262  1              ST[3]=ST[3]&0xfd;
  263  1      
  264  1              if(P1_IN_P3==0)                         //SP10
  265  1              ST[3]=ST[3]|0x04;
  266  1              else
  267  1              ST[3]=ST[3]&0xfb;
  268  1      
  269  1              if(P10_IN_P14==0)                       //SP11
  270  1              ST[3]=ST[3]|0x08;
  271  1              else
  272  1              ST[3]=ST[3]&0xf7;
  273  1      
  274  1              if(P1_IN_P4==0)                         //SP12
  275  1              ST[3]=ST[3]|0x10;
  276  1              else
  277  1              ST[3]=ST[3]&0xef;
  278  1      
  279  1              if(P10_IN_P15==0)                       //SP13
  280  1              ST[3]=ST[3]|0x20;
  281  1              else
  282  1              ST[3]=ST[3]&0xdf;
  283  1      
  284  1              if(P1_IN_P5==0)                         //SP14
  285  1              ST[3]=ST[3]|0x40;
  286  1              else
  287  1              ST[3]=ST[3]&0xbf;
  288  1      
  289  1              if(P1_IN_P6==0)                         //SP15
  290  1              ST[3]=ST[3]|0x80;
  291  1              else
  292  1              ST[3]=ST[3]&0x7f;
  293  1      }
  294         
  295         void Switch_Control(void)
  296         {
  297  1              //µÍ±ß¿ª¹Ø£º´ÓÉÏµ½ÏÂÎª1~10 1:off 0:on OUT¹Ü½ÅÓÐÐ§Ïàµ±ÓÚµØ¡£
  298  1              
  299  1              P7_OUT_P3  = ST[4]&0x01;                                        //µÍ±ß¿ª¹Ø1£¬¶¨ÒåÎª¿ØÖÆ×ªÏò¼°É²³µÉÏµçÐÅºÅµÄ¼ÌµçÆ÷Òý½Å  10ºÅÒý½Å½Ó¹©µç 14º
             -ÅµØÏß 63  [10-1 31-2 30-9 32-6 29-3 28-7] 
  300  1                                                                                                                                                                                                                                                                              //[14 18 22 23 24 33 gnd]
  301  1              P7_OUT_P4  =(ST[4]>>1)&0x01;                            //µÍ±ß¿ª¹Ø2£¬
  302  1                              
C166 COMPILER V7.00, MAIN                                                                  04/01/2020 13:21:46 PAGE 6   

  303  1              P6_OUT_P0  =(ST[4]>>2)&0x01;                            //µÍ±ß¿ª¹Ø3      29                        
  304  1                              
  305  1              P10_OUT_P10=(ST[4]>>3)&0x01;                            //µÍ±ß¿ª¹Ø4      12
  306  1                              
  307  1              P10_OUT_P11=(ST[4]>>4)&0x01;                            //µÍ±ß¿ª¹Ø5      9
  308  1                              
  309  1              P1_OUT_P2  =(ST[4]>>5)&0x01;                            //µÍ±ß¿ª¹Ø6      32
  310  1                                   
  311  1              P10_OUT_P8 =(ST[4]>>6)&0x01;                            //µÍ±ß¿ª¹Ø7      28
  312  1                              
  313  1              P10_OUT_P13=(ST[4]>>7)&0x01;                            //µÍ±ß¿ª¹Ø8      13
  314  1                              
  315  1              P0_OUT_P7  = ST[5]&0x01;                                        //µÍ±ß¿ª¹Ø9      30
  316  1                              
  317  1              P1_OUT_P0  =(ST[5]>>1)&0x01;                            //µÍ±ß¿ª¹Ø10  11
  318  1                                                       
  319  1              //¸ß±ß¿ª¹Ø£º´ÓÉÏµ½ÏÂÎª1~4 1:on 0:off£¬OUT¹Ü½ÅÓÐÐ§Ïàµ±ÓÚ+24V/12V¡£
  320  1                                        
  321  1              P10_OUT_P3 = ST[6]&0x01;                                        //¸ß±ß¿ª¹Ø1       63 Ç°´óµÆ  
  322  1                              
  323  1              P0_OUT_P5  =(ST[6]>>1)&0x01;                            //¸ß±ß¿ª¹Ø2       64 ºó´óµÆ
  324  1                              
  325  1              P10_OUT_P4 =(ST[6]>>2)&0x01;                            //¸ß±ß¿ª¹Ø3
  326  1                              
  327  1              P1_OUT_P1  =(ST[6]>>3)&0x01;                            //¸ß±ß¿ª¹Ø4             
  328  1      }
  329         
  330         // ¿ÂÄ¬µç¶¯ ´Ë´¦¶¨ÒåÄ£Êý×ª»»º¯Êý ´ÓÉÏµ½ÏÂÊÇÍ¨µÀAI1~6
  331         void ADC_State(void)                                                              
  332         {
  333  1              ADC1_vStartSeq0ReqChNum(0,0,0,0);
  334  1              while(!(ADC1_RCR0 & 0x1000));                           //AI1£¬5V¶ÔÓ¦0x03FF¡£                                    
  335  1          ADC_High[1]=((ADC1_RESR0>>2)&0x0300)>>8;            //high 2bit
*** WARNING C192 IN LINE 335 OF MAIN.C: '=': value truncated
  336  1              ADC_Low[1] =((ADC1_RESR0>>2)&0x00ff);                   //low  8bit
*** WARNING C192 IN LINE 336 OF MAIN.C: '=': value truncated
  337  1              delay(500);
  338  1      
  339  1              ADC1_vStartSeq0ReqChNum(0,0,0,2);
  340  1              while(!(ADC1_RCR2 & 0x1000));                                   //AI2£¬5V¶ÔÓ¦0x03FF¡£            
  341  1              ADC_High[2]=((ADC1_RESR2>>2)&0x0300)>>8;            //high 2bit
*** WARNING C192 IN LINE 341 OF MAIN.C: '=': value truncated
  342  1              ADC_Low[2] =((ADC1_RESR2>>2)&0x00ff);           //low  8bit
*** WARNING C192 IN LINE 342 OF MAIN.C: '=': value truncated
  343  1              delay(500);     
  344  1      
  345  1              ADC1_vStartSeq0ReqChNum(0,0,0,4);
  346  1              while(!(ADC1_RCR4 & 0x1000));                           //AI3£¬5V¶ÔÓ¦0x03FF¡£
  347  1              ADC_High[3]=((ADC1_RESR4>>2)&0x0300)>>8;                //high 2bit       
*** WARNING C192 IN LINE 347 OF MAIN.C: '=': value truncated
  348  1              ADC_Low[3] =((ADC1_RESR4>>2)&0x00ff);                   //low  8bit
*** WARNING C192 IN LINE 348 OF MAIN.C: '=': value truncated
  349  1              delay(500);
  350  1      
  351  1          ADC1_vStartSeq0ReqChNum(0,0,0,5);
  352  1              while(!(ADC1_RCR5 & 0x1000));                                   // AI4£¬24V/5V¶ÔÓ¦0x03FF¡£
  353  1              ADC_High[4]=((ADC1_RESR5>>2)&0x0300)>>8;                //high 2bit             
*** WARNING C192 IN LINE 353 OF MAIN.C: '=': value truncated
  354  1              ADC_Low[4] =((ADC1_RESR5>>2)&0x00ff);                   //low  8bit 
*** WARNING C192 IN LINE 354 OF MAIN.C: '=': value truncated
  355  1              delay(500);
  356  1      
C166 COMPILER V7.00, MAIN                                                                  04/01/2020 13:21:46 PAGE 7   

  357  1              ADC1_vStartSeq0ReqChNum(0,0,0,6);
  358  1              while(!(ADC1_RCR6 & 0x1000));                                   // AI5£¬24V/5V¶ÔÓ¦0x03FF¡£
  359  1              ADC_High[5]=((ADC1_RESR6>>2)&0x0300)>>8;                //high 2bit
*** WARNING C192 IN LINE 359 OF MAIN.C: '=': value truncated
  360  1              ADC_Low[5] =((ADC1_RESR6>>2)&0x00ff);                   //low  8bit
*** WARNING C192 IN LINE 360 OF MAIN.C: '=': value truncated
  361  1              delay(500);
  362  1      
  363  1              ADC0_vStartSeq0ReqChNum(0,0,0,0);
  364  1              while(!(ADC0_RCR0 & 0x1000));                                   // AI6£¬24V/5V¶ÔÓ¦0x03FF¡£
  365  1              ADC_High[6]=((ADC0_RESR0>>2)&0x0300)>>8;                //high 2bit     
*** WARNING C192 IN LINE 365 OF MAIN.C: '=': value truncated
  366  1              ADC_Low[6] =((ADC0_RESR0>>2)&0x00ff);                   //low  8bit
*** WARNING C192 IN LINE 366 OF MAIN.C: '=': value truncated
  367  1      }
  368         
  369         // ¿ÂÄ¬µç¶¯ ´Ë´¦¶¨ÒåµÍ±ß¿ª¹ØSPI¿ØÖÆÄ£Ê½ ±¾º¯ÊýÐèÔÚwhileÖÐÑ­»·
  370         void SPI_Control(void)
  371         {
  372  1              P0_OUT_P3=1;                                                      //
  373  1              delay(3);                                                                 //
  374  1              P0_OUT_P3=0;                                                      //
  375  1              delay(3);                                                                 //
  376  1                                                                                                //
  377  1              U1C0_SSC_vSendData(0x24ff);                           //
  378  1          while(!U1C0_SSC_ubTxDataReady());             //
  379  1                                                                                                //
  380  1              P0_OUT_P3=1;                                                      //
  381  1              delay(3);                                                                 //
  382  1              P0_OUT_P3=0;                                                      //
  383  1              delay(3);                                                                 //
  384  1              U1C0_SSC_vSendData(0x27ff);                       //
  385  1          while(!U1C0_SSC_ubTxDataReady());             //
  386  1                                                                                                //
  387  1              P0_OUT_P3=1;                                                      //
  388  1              delay(3);                                                                 //
  389  1              P0_OUT_P3=0;                                                      //
  390  1              delay(3);                                                                 //
  391  1              U1C0_SSC_vSendData(0x2ecf);                       //
  392  1          while(!U1C0_SSC_ubTxDataReady());             //
  393  1                                                                                                //
  394  1              delay(3);                                                                 //
  395  1          P0_OUT_P3=1;                                          //
  396  1      } 
  397                                                                                         
  398         // USER CODE END
  399         
  400         
  401         //****************************************************************************
  402         // @Function      void MAIN_vInit(void) 
  403         //
  404         //----------------------------------------------------------------------------
  405         // @Description   This function initializes the microcontroller.
  406         //
  407         //----------------------------------------------------------------------------
  408         // @Returnvalue   None
  409         //
  410         //----------------------------------------------------------------------------
  411         // @Parameters    None
  412         //
  413         //----------------------------------------------------------------------------
  414         // @Date          2020/1/14
C166 COMPILER V7.00, MAIN                                                                  04/01/2020 13:21:46 PAGE 8   

  415         //
  416         //****************************************************************************
  417         
  418         // USER CODE BEGIN (Init,1)
  419         
  420         // USER CODE END
  421         
  422         void MAIN_vInit(void)
  423         {
  424  1      
  425  1        SCS_ErrorType Error;
  426  1      
  427  1        // USER CODE BEGIN (Init,2)
  428  1        auto_cmd.steering = 7800;
  429  1        // USER CODE END
  430  1      
  431  1        //   globally disable interrupts
  432  1        PSW_IEN        =  0;          
  433  1      
  434  1        ///  -----------------------------------------------------------------------
  435  1        ///  Configuration of the System Clock:
  436  1        ///  -----------------------------------------------------------------------
  437  1        ///  - VCO clock used, input clock is connected
  438  1        ///  - input frequency is 8.00 MHz
  439  1        ///  - configured system frequency is 80.00 MHz
  440  1        ///  - system clock is 80.00MHz
  441  1      
  442  1        MAIN_vUnlockProtecReg();     // unlock write security
  443  1      
  444  1        // initialize CCU6 timer T13 for SCS driver
  445  1        SCS_InitTimer();
  446  1      
  447  1        // perform transition from base mode to normal operating mode
  448  1        Error = SCS_GoFromBaseToNormalMode();
  449  1      
  450  1        // restore CCU6 timer used by SCS driver
  451  1        SCS_RestoreTimer();
  452  1      
  453  1        //   -----------------------------------------------------------------------
  454  1        //   Initialization of the Peripherals:
  455  1        //   -----------------------------------------------------------------------
  456  1      
  457  1        //   initializes the Parallel Ports
  458  1        IO_vInit();
  459  1      
  460  1        //   initializes the General Purpose Timer Unit (GPT1)
  461  1        GPT1_vInit();
  462  1      
  463  1        //   initializes the General Purpose Timer Unit (GPT2)
  464  1        GPT2_vInit();
  465  1      
  466  1        //   initializes the Analog / Digital Converter  (ADC0)
  467  1        ADC0_vInit();
  468  1      
  469  1        //   initializes the Analog / Digital Converter (ADC1)
  470  1        ADC1_vInit();
  471  1      
  472  1        //   initializes the MultiCAN Module (CAN)
  473  1        CAN_vInit();
  474  1      
  475  1        //   initializes the USIC0 Module
  476  1        USIC0_vInit();
C166 COMPILER V7.00, MAIN                                                                  04/01/2020 13:21:46 PAGE 9   

  477  1      
  478  1        //   initializes the USIC1 Module
  479  1        USIC1_vInit();
  480  1      
  481  1      
  482  1        //   -----------------------------------------------------------------------
  483  1        //   Initialization of the Bank Select registers:
  484  1        //   -----------------------------------------------------------------------
  485  1      
  486  1      
  487  1        // USER CODE BEGIN (Init,3)
  488  1      
  489  1        delay(1000);
  490  1      
  491  1        // USER CODE END
  492  1      
  493  1        MAIN_vLockProtecReg();       // lock write security
  494  1      
  495  1        //   globally enable interrupts
  496  1        PSW_IEN        =  1;          
  497  1      
  498  1      } //  End of function MAIN_vInit
  499         
  500         
  501         //****************************************************************************
  502         // @Function      void MAIN_vUnlockProtecReg(void) 
  503         //
  504         //----------------------------------------------------------------------------
  505         // @Description   This function makes it possible to write one protected 
  506         //                register.
  507         //
  508         //----------------------------------------------------------------------------
  509         // @Returnvalue   None
  510         //
  511         //----------------------------------------------------------------------------
  512         // @Parameters    None
  513         //
  514         //----------------------------------------------------------------------------
  515         // @Date          2020/1/14
  516         //
  517         //****************************************************************************
  518         
  519         // USER CODE BEGIN (UnlockProtecReg,1)
  520         
  521         // USER CODE END
  522         
  523         void MAIN_vUnlockProtecReg(void)
  524         {
  525  1      
  526  1          SCU_SLC = 0xAAAA;                   // command 0
  527  1          SCU_SLC = 0x5554;                   // command 1
  528  1          SCU_SLC = 0x96FF;                   // command 2
  529  1          SCU_SLC = 0x0000;                   // command 3
  530  1      
  531  1      } //  End of function MAIN_vUnlockProtecReg
  532         
  533         
  534         //****************************************************************************
  535         // @Function      void MAIN_vLockProtecReg(void) 
  536         //
  537         //----------------------------------------------------------------------------
  538         // @Description   This function makes it possible to lock one protected 
C166 COMPILER V7.00, MAIN                                                                  04/01/2020 13:21:46 PAGE 10  

  539         //                register.
  540         //
  541         //----------------------------------------------------------------------------
  542         // @Returnvalue   None
  543         //
  544         //----------------------------------------------------------------------------
  545         // @Parameters    None
  546         //
  547         //----------------------------------------------------------------------------
  548         // @Date          2020/1/14
  549         //
  550         //****************************************************************************
  551         
  552         // USER CODE BEGIN (LockProtecReg,1)
  553         
  554         // USER CODE END
  555         
  556         void MAIN_vLockProtecReg(void)
  557         {
  558  1      
  559  1          SCU_SLC = 0xAAAA;                   // command 0
  560  1          SCU_SLC = 0x5554;                   // command 1
  561  1          SCU_SLC = 0x96FF;                   // command 2
  562  1          SCU_SLC = 0x1800;                   // command 3;
  563  1          SCU_SLC = 0x8EFF;                   // command 4
  564  1      
  565  1      } //  End of function MAIN_vLockProtecReg
  566         
  567         
  568         //****************************************************************************
  569         // @Function      void main(void) 
  570         //
  571         //----------------------------------------------------------------------------
  572         // @Description   This is the main function.
  573         //
  574         //----------------------------------------------------------------------------
  575         // @Returnvalue   None
  576         //
  577         //----------------------------------------------------------------------------
  578         // @Parameters    None
  579         //
  580         //----------------------------------------------------------------------------
  581         // @Date          2020/1/14
  582         //
  583         //****************************************************************************
  584         
  585         // USER CODE BEGIN (Main,1)
  586         
  587         // ¿ÂÄ¬µç¶¯ ´Ë´¦½øÐÐ±äÁ¿¶¨Òå ÔÚMAIN.HÖÐ½øÐÐ±äÁ¿È«¾ÖÉùÃ÷
  588         ubyte ST[8];                                                                                                                    // ¿ª¹ØÁ¿²É¼¯¼°¿ØÖÆ
  589         
  590         ubyte Data3[8], Data4[8], Data5[8],CAN_Mark[8];                                                 // CAN½ÓÊÕÊý¾Ý ÖÐ¶Ï±êÖ¾ ²âÊÔ·¢ËÍÊý¾Ý
  591         ubyte CAN_Test[8]={0x01,0x03,0x07,0x0F,0x1F,0x3F,0x7F,0xFF}; 
  592         ubyte CAN_Break_Timer=0,CAN_Break_Flag=0;                                                               // CAN¶ÏÏßÊ±¼ä ¶ÏÏß±êÖ¾
  593         
  594         ubyte CC2_Mark[8],Period_Low[8],Period_High[8];                                                 // »ô¶ûÂÖËÙ ²¶×½ÖÐ¶Ï ÖÜÆÚ¸ßµÍ×Ö½Ú
  595         uword Period[8];                                                                                                                // ÖÜÆÚ
  596         
  597         ubyte ADC_High[8]={0},ADC_Low[8]={0};                                                                   // Ä£ÄâÁ¿×ª»»¸ßµÍ×Ö½Ú
  598         
  599         ubyte T_Mark[8]={0},T_Mark_i[8]={0};                                                                    // ¶¨Ê±Æ÷±êÖ¾
  600         
C166 COMPILER V7.00, MAIN                                                                  04/01/2020 13:21:46 PAGE 11  

  601         
  602         // USER CODE END
  603         
  604         void main(void)
  605         {
  606  1        // USER CODE BEGIN (Main,2)
  607  1        extern int autohold_mark;
  608  1        extern int servo_breaking_init();
  609  1        int em_stop_mark=0;
  610  1        int times=0;
  611  1        int time_i=0;
  612  1              //¿ÂÄ¬µç¶¯ ³õÊ¼»¯±äÁ¿
  613  1              ST[4] = 0xFF; 
  614  1              ST[5] = 0xFF;
  615  1              ST[6] = 0x00;
  616  1      
  617  1        // USER CODE END
  618  1      
  619  1        MAIN_vInit();
  620  1      
  621  1        // USER CODE BEGIN (Main,3)
  622  1      
  623  1              SPI_Control();   
  624  1              servo_breaking_init();  
  625  1              P7_OUT_P3 = 1;  //10 ×ó×ªÏò
  626  1              P7_OUT_P4 = 1;  //31 µç×ÓÊÖÉ²·Å
  627  1              P6_OUT_P0 =1;   //29 Ç°Î²µÆ
  628  1              P10_OUT_P10 =1; //12 Ê¾¿íµÆ
  629  1              P10_OUT_P11 =1; //9  ÖÆ¶¯µÆ
  630  1              P1_OUT_P2  =1;  //32 µç×ÓÊÖÉ²À­
  631  1              P10_OUT_P8=1;   //28 ÉÏµçÐÅºÅ
  632  1              P10_OUT_P13 =1; //13 Î²µÆ
  633  1              P0_OUT_P7=1;    //30 Ç°ÖÆ¶¯µÆ
  634  1              P1_OUT_P0 =1;   //11 ÓÒ×ªÏò
  635  1      
  636  1              P10_OUT_P3 =0;  //  ºó´óµÆ
  637  1              P0_OUT_P5=0;    //Ç°´óµÆ
  638  1              
  639  1              P10_OUT_P10 =0; 
  640  1              time_out_remote = 0x55; 
  641  1              remote_re.key=TRUE;   
  642  1              while(remote_re.key==TRUE);  //µÈ´ý½ÓÊÕµ½Ò£¿ØÆ÷ÐÅºÅ                                     
  643  1              //delay_100ms(1);       
  644  1              SPI_Control();
  645  1              //ÉÁË¸Á½Ãë±íÊ¾Æô¶¯
  646  1      
  647  1              for(delay_time=0;delay_time<20;){P1_OUT_P0 =0;P7_OUT_P3 =0;SPI_Control();}
  648  1              P7_OUT_P3 = 1;
  649  1              P1_OUT_P0 =1;
  650  1              //³õÊ¼»¯ÊÖÉ²
  651  1              hand_break_mark = FALSE;
  652  1              for(delay_time=0;delay_time<30;){autohold(TRUE);SPI_Control();}
  653  1              //hand_break_mark = TRUE;
  654  1              //for(delay_time=0;delay_time<30;){autohold(FALSE);SPI_Control();}
  655  1              //ÉÏµçÐÅºÅ
  656  1              P10_OUT_P8=0;
  657  1              P10_OUT_P13 =0;
  658  1              P10_OUT_P10=0;
  659  1              
  660  1        // USER CODE END
  661  1      
  662  1        while(1)
C166 COMPILER V7.00, MAIN                                                                  04/01/2020 13:21:46 PAGE 12  

  663  1        {
  664  2      
  665  2         // USER CODE BEGIN (Main,4)
  666  2      
  667  2              SPI_Control();                                  // SPI¿ØÖÆ whileÖÐÑ­»·
  668  2      
  669  2              //ADC_State();                                          // Ä£ÄâÁ¿×´Ì¬²É¼¯º¯Êý 
  670  2              
  671  2              Switch_State();                                 // ¿ª¹ØÁ¿×´Ì¬²É¼¯º¯Êý   
  672  2      
  673  2              //Switch_Control();                             // ¿ª¹ØÁ¿¿ØÖÆº¯Êý
  674  2      
  675  2              if(remote_re.t_em_stop == TRUE||remote_re.key==TRUE)//¼±Í£»òÕßÒ£¿ØÐÅºÅ¶ªÊ§      
  676  2              {
  677  3                      P7_OUT_P3 = 0;
  678  3                      P1_OUT_P0 =0;
  679  3                      remote_re.t_way_trl=0;
  680  3                      if(vehicle_rcv.lfw.rpm+vehicle_rcv.lbw.rpm+vehicle_rcv.rfw.rpm\
  681  3              +vehicle_rcv.rbw.rpm>0||hand_break_mark==FALSE)send_break(BREAKING_MAX,0x10);
  682  3                      else send_break(BREAKING_FREE,0x10);
  683  3                      em_stop_mark=1;
  684  3              }else if(remote_re.t_em_stop == FALSE&&remote_re.key==FALSE&&em_stop_mark==1)
  685  2              {
  686  3                      P7_OUT_P3 = 1;
  687  3                      P1_OUT_P0 =1;
  688  3                      remote_re.t_way_trl=0; //Ò£¿ØÄ£Ê½
  689  3                      send_break(BREAKING_FREE,0x10); 
  690  3                      em_stop_mark=0;
  691  3              }       
  692  2      
  693  2              if(remote_re.hand_break==TRUE)  // À­ÊÖÉ²,½ûÖ¹·¢ËÍËÙ¶ÈÖµ                         //||auto_cmd.hand_break==TRUE //||auto_cmd.ha
             -nd_break==TRUE
  694  2                      autohold(TRUE);
  695  2              else if(remote_re.hand_break==FALSE&&autohold_mark==0) 
  696  2                      autohold(FALSE);
  697  2      
  698  2              if(time_hand_break>15)//±£»¤µç»ú±ÜÃâ¶Â×ª
  699  2              {
  700  3                      P7_OUT_P4=1;
  701  3                      P1_OUT_P2=1;
  702  3                      }
  703  2      /*      //²âÊÔ´óµÆ¿ª¹Ø                  
  704  2              if(remote_re.t_backup1 == 1)
  705  2                      P0_OUT_P5 = 1;
  706  2              else if(remote_re.t_backup1 == 2){
  707  2                      P10_OUT_P3=0;
  708  2                      P0_OUT_P5=0;
  709  2              }else if(remote_re.t_backup1 == 3)      
  710  2                      P10_OUT_P3=1;
  711  2      */
  712  2              //auto_autohold();//×Ô¶¯ÊÖÉ²
  713  2      
  714  2                         
  715  2         // USER CODE END
  716  2      
  717  2        }
  718  1      
  719  1      } //  End of function main
  720         
  721         
  722         
  723         // USER CODE BEGIN (MAIN_General,10)
C166 COMPILER V7.00, MAIN                                                                  04/01/2020 13:21:46 PAGE 13  

  724         
  725         // USER CODE END
  726         


MODULE INFORMATION:   INITIALIZED  UNINITIALIZED
  CODE SIZE        =        2052     --------
  NEAR-CONST SIZE  =    --------     --------
  FAR-CONST SIZE   =    --------     --------
  HUGE-CONST SIZE  =    --------     --------
  XHUGE-CONST SIZE =    --------     --------
  NEAR-DATA SIZE   =         124     --------
  FAR-DATA SIZE    =    --------     --------
  XHUGE-DATA SIZE  =    --------     --------
  IDATA-DATA SIZE  =    --------     --------
  SDATA-DATA SIZE  =    --------     --------
  BDATA-DATA SIZE  =    --------     --------
  HUGE-DATA SIZE   =    --------     --------
  BIT SIZE         =    --------     --------
  INIT'L SIZE      =          72     --------
END OF MODULE INFORMATION.


C166 COMPILATION COMPLETE.  12 WARNING(S),  0 ERROR(S)
