C166 COMPILER V7.00, GPT2                                                                  04/01/2020 13:45:19 PAGE 1   


C166 COMPILER V7.00, COMPILATION OF MODULE GPT2
OBJECT MODULE PLACED IN GPT2.obj
COMPILER INVOKED BY: H:\KEILC166\C166\BIN\C166.EXE source\GPT2.c MODV2 BROWSE INCDIR(.\source;.\lib) MODV2 DEBUG PRINT(.
                    -\GPT2.lst) OBJECT(GPT2.obj) 

 stmt lvl     source

    1         //****************************************************************************
    2         // @Module        General Purpose Timer Unit (GPT2)
    3         // @Filename      GPT2.c
    4         // @Project       tiaoshi.dav
    5         //----------------------------------------------------------------------------
    6         // @Controller    Infineon XC2267M-104F80
    7         //
    8         // @Compiler      Keil
    9         //
   10         // @Codegenerator 2.0
   11         //
   12         // @Description   This file contains functions that use the GPT2 module.
   13         //
   14         //----------------------------------------------------------------------------
   15         // @Date          2020/1/14 16:27:48
   16         //
   17         //****************************************************************************
   18         
   19         // USER CODE BEGIN (GPT2_General,1)
   20         
   21         // USER CODE END
   22         
   23         
   24         
   25         //****************************************************************************
   26         // @Project Includes
   27         //****************************************************************************
   28         
   29         #include "MAIN.h"
   30         
   31         // USER CODE BEGIN (GPT2_General,2)
   32         #include "remote.h"
   33         #include "steering.h"
   34         #include "vehicle_control.h"
   35         // USER CODE END
   36         
   37         
   38         //****************************************************************************
   39         // @Macros
   40         //****************************************************************************
   41         
   42         // USER CODE BEGIN (GPT2_General,3)
   43         
   44         // USER CODE END
   45         
   46         
   47         //****************************************************************************
   48         // @Defines
   49         //****************************************************************************
   50         
   51         // USER CODE BEGIN (GPT2_General,4)
   52         
   53         // USER CODE END
   54         
C166 COMPILER V7.00, GPT2                                                                  04/01/2020 13:45:19 PAGE 2   

   55         
   56         //****************************************************************************
   57         // @Typedefs
   58         //****************************************************************************
   59         
   60         // USER CODE BEGIN (GPT2_General,5)
   61         
   62         // USER CODE END
   63         
   64         
   65         //****************************************************************************
   66         // @Imported Global Variables
   67         //****************************************************************************
   68         
   69         // USER CODE BEGIN (GPT2_General,6)
   70         
   71         // USER CODE END
   72         
   73         
   74         //****************************************************************************
   75         // @Global Variables
   76         //****************************************************************************
   77         
   78         // USER CODE BEGIN (GPT2_General,7)
   79         
   80         // USER CODE END
   81         
   82         
   83         //****************************************************************************
   84         // @External Prototypes
   85         //****************************************************************************
   86         
   87         // USER CODE BEGIN (GPT2_General,8)
   88         
   89         // USER CODE END
   90         
   91         
   92         
   93         //****************************************************************************
   94         // @Prototypes Of Local Functions
   95         //****************************************************************************
   96         
   97         // USER CODE BEGIN (GPT2_General,9)
   98         
   99         // USER CODE END
  100         
  101         
  102         //****************************************************************************
  103         // @Function      void GPT2_vInit(void) 
  104         //
  105         //----------------------------------------------------------------------------
  106         // @Description   This is the initialization function of the GPT2 function 
  107         //                library. It is assumed that the SFRs used by this library 
  108         //                are in reset state. 
  109         //
  110         //----------------------------------------------------------------------------
  111         // @Returnvalue   None
  112         //
  113         //----------------------------------------------------------------------------
  114         // @Parameters    None
  115         //
  116         //----------------------------------------------------------------------------
C166 COMPILER V7.00, GPT2                                                                  04/01/2020 13:45:19 PAGE 3   

  117         // @Date          2020/1/14
  118         //
  119         //****************************************************************************
  120         
  121         // USER CODE BEGIN (Init,1)
  122         
  123         // USER CODE END
  124         
  125         void GPT2_vInit(void)
  126         {
  127  1      
  128  1        // USER CODE BEGIN (Init,2)
  129  1      
  130  1        // USER CODE END
  131  1        ///  -----------------------------------------------------------------------
  132  1        ///  Configuration of Timer Block Prescaler 1:
  133  1        ///  -----------------------------------------------------------------------
  134  1        GPT12E_KSCCFG  =  0x0003;      // Module Enable
  135  1      
  136  1      
  137  1        _nop_();  // one cycle delay 
  138  1      
  139  1        _nop_();  // one cycle delay 
  140  1      
  141  1      
  142  1        ///  -----------------------------------------------------------------------
  143  1        ///  Configuration of Timer Block Prescaler 2:
  144  1        ///  -----------------------------------------------------------------------
  145  1        ///  - prescaler for timer block 2 is 4
  146  1      
  147  1      
  148  1        ///  -----------------------------------------------------------------------
  149  1        ///  Configuration of the GPT2 Core Timer 5:
  150  1        ///  -----------------------------------------------------------------------
  151  1        ///  - timer 5 works in timer mode
  152  1        ///  - prescaler factor is 128
  153  1        ///  - up/down control bit is reset
  154  1        ///  - external up/down control is disabled
  155  1        ///  - timer 5 remote control is disabled
  156  1      
  157  1        GPT12E_T5CON   =  0x0005;      // load timer 5 control register
  158  1        GPT12E_T5      =  0x85EE;      // load timer 5 register
  159  1      
  160  1        ///  -----------------------------------------------------------------------
  161  1        ///  Configuration of the GPT2 Core Timer 6:
  162  1        ///  -----------------------------------------------------------------------
  163  1        ///  - timer 6 works in timer mode
  164  1        ///  - prescaler factor is 128
  165  1        ///  - up/down control bit is reset
  166  1        ///  - external up/down control is disabled
  167  1        ///  - alternate output function T6OUT (P6.2) is disabled
  168  1        ///  - alternate output function T6OUT (P7.0) is disabled
  169  1        ///  - timer 6 output toggle latch (T6OTL) is set to 0
  170  1        ///  - timer 6 is not cleared on a capture
  171  1      
  172  1        GPT12E_T6CON   =  0x0005;      // load timer 6 control register
  173  1        GPT12E_T6      =  0x85EE;      // load timer 6 register
  174  1      
  175  1        ///  -----------------------------------------------------------------------
  176  1        ///  Configuration of the GPT2 CAPREL:
  177  1        ///  -----------------------------------------------------------------------
  178  1        ///  - capture T5 into CAPREL is disabled
C166 COMPILER V7.00, GPT2                                                                  04/01/2020 13:45:19 PAGE 4   

  179  1        ///  - capture trigger from pin CAPIN
  180  1        ///  - capure is disabled
  181  1        ///  - timer 5 is not cleared on a capture
  182  1        ///  - timer 5 is just captured without any correction
  183  1      
  184  1        GPT12E_T5CON  |=  0x0000;      // load timer 5 control register
  185  1        GPT12E_CAPREL  =  0x0000;      // load CAPREL register
  186  1      
  187  1        ///  -----------------------------------------------------------------------
  188  1        ///  Configuration of the used GPT2 Port Pins:
  189  1        ///  -----------------------------------------------------------------------
  190  1      
  191  1      
  192  1      
  193  1        ///  -----------------------------------------------------------------------
  194  1        ///  Configuration of the used GPT2 Interrupts:
  195  1        ///  -----------------------------------------------------------------------
  196  1        ///  timer 5 service request node configuration:
  197  1        ///  - timer 5 interrupt priority level (ILVL) = 11
  198  1        ///  - timer 5 interrupt group level (GLVL) = 0
  199  1        ///  - timer 5 group priority extension (GPX) = 0
  200  1      
  201  1        GPT12E_T5IC    =  0x006C;     
  202  1      
  203  1        ///  timer 6 service request node configuration:
  204  1        ///  - timer 6 interrupt priority level (ILVL) = 12
  205  1        ///  - timer 6 interrupt group level (GLVL) = 0
  206  1        ///  - timer 6 group priority extension (GPX) = 0
  207  1      
  208  1        GPT12E_T6IC    =  0x0070;     
  209  1      
  210  1      
  211  1      
  212  1        // USER CODE BEGIN (GPT2_Function,3)
  213  1      
  214  1        // USER CODE END
  215  1      
  216  1        GPT12E_T5CON_T5R  =  1;        // set timer 5 run bit
  217  1      
  218  1        GPT12E_T6CON_T6R  =  1;        // set timer 6 run bit
  219  1      
  220  1      } //  End of function GPT2_viCAPREL
  221         
  222         //****************************************************************************
  223         // @Function      void GPT2_viTmr6(void) 
  224         //
  225         //----------------------------------------------------------------------------
  226         // @Description   This is the interrupt service routine for the GPT2 timer 6. 
  227         //                It is called up in the case of over or underflow of the 
  228         //                timer 6 register.
  229         //                
  230         //                Please note that you have to add application specific code 
  231         //                to this function.
  232         //
  233         //----------------------------------------------------------------------------
  234         // @Returnvalue   None
  235         //
  236         //----------------------------------------------------------------------------
  237         // @Parameters    None
  238         //
  239         //----------------------------------------------------------------------------
  240         // @Date          2020/1/14
C166 COMPILER V7.00, GPT2                                                                  04/01/2020 13:45:19 PAGE 5   

  241         //
  242         //****************************************************************************
  243         
  244         // USER CODE BEGIN (Tmr6,1)
  245                 
  246                 //  100ms定时器
  247                 // GPT12E_T6=0xC2F7；
  248                 //command recive time out data clean
  249         int time_out_remote =0,time_out_auto=0;
  250         extern int delay_time;
  251                 extern struct self_driving auto_cmd;
  252                 extern struct remote_receive remote_re;
  253                 extern int time_hand_break,hand_break_mark,time_auto_hand_break;
  254         // USER CODE END
  255         
  256         void GPT2_viTmr6(void) interrupt T6INT
  257         {
  258  1        // USER CODE BEGIN (Tmr6,2)
  259  1      
  260  1              time_out_auto++;
  261  1              time_out_remote++;
  262  1              time_hand_break++;
  263  1              time_auto_hand_break++;
  264  1              T_Mark_i[6]++;  
  265  1              if(T_Mark_i[6] >= 10){T_Mark_i[6] = 0; T_Mark[6]++;}
  266  1              if(T_Mark[6]>=100)      T_Mark[6]=0;
  267  1      
  268  1                      Data3[0] = 0xaa;        
  269  1                      CAN_vLoadData(DBO_77,Data3);     //310-340  8-11   
  270  1                      CAN_vTransmit(DBO_77);
  271  1      
  272  1              //如果超时则清除所有滞留的敏感数据，如速度，转向等
  273  1              if(time_out_auto>5) //500ms
  274  1                      {
  275  2                              auto_cmd.speed = 0;
  276  2                              auto_cmd.steering = 0;
  277  2                              auto_cmd.gear = 2;      
  278  2                              //remote 
  279  2                      
  280  2                      }
  281  1              if(time_out_remote>5)
  282  1                      {
  283  2                              remote_re.t_steering_vle = 0;
  284  2                              remote_re.t_throttle_vle = 0;                   
  285  2                      }
  286  1                      
  287  1              delay_time++; //一次20ms
  288  1              if(delay_time == 65530)
  289  1                      delay_time=1000; 
  290  1              if(time_hand_break>30000)
  291  1                      time_hand_break=1000;  //防止溢出
  292  1              if(time_auto_hand_break>30000)
  293  1                      time_auto_hand_break=1000;
  294  1      
  295  1      
  296  1        // USER CODE END
  297  1      
  298  1      } //  End of function GPT2_viTmr6
  299         
  300         
  301         //****************************************************************************
  302         // @Function      void GPT2_viTmr5(void) 
C166 COMPILER V7.00, GPT2                                                                  04/01/2020 13:45:19 PAGE 6   

  303         //
  304         //----------------------------------------------------------------------------
  305         // @Description   This is the interrupt service routine for the GPT2 timer 5. 
  306         //                It is called up in the case of over or underflow of the 
  307         //                timer 5 register.
  308         //                
  309         //                Please note that you have to add application specific code 
  310         //                to this function.
  311         //
  312         //----------------------------------------------------------------------------
  313         // @Returnvalue   None
  314         //
  315         //----------------------------------------------------------------------------
  316         // @Parameters    None
  317         //
  318         //----------------------------------------------------------------------------
  319         // @Date          2020/1/14
  320         //
  321         //****************************************************************************
  322         
  323         // USER CODE BEGIN (Tmr5,1)
  324         
  325                 // 柯默电动 200ms定时器
  326                 // GPT12E_T5=0x0BDC；
  327         
  328         // USER CODE END
  329         
  330         void GPT2_viTmr5(void) interrupt T5INT
  331         {
  332  1        // USER CODE BEGIN (Tmr5,2)
  333  1      
  334  1              T_Mark_i[5]++;  
  335  1              if(T_Mark_i[5] >= 5){T_Mark_i[5] = 0; T_Mark[5]++;}
  336  1              if(T_Mark[5]>=100)      T_Mark[5]=0;
  337  1      
  338  1        // USER CODE END
  339  1      
  340  1      } //  End of function GPT2_viTmr5
  341         
  342         
  343         
  344         
  345         // USER CODE BEGIN (GPT2_General,10)
  346         
  347         // USER CODE END
  348         


MODULE INFORMATION:   INITIALIZED  UNINITIALIZED
  CODE SIZE        =         332     --------
  NEAR-CONST SIZE  =    --------     --------
  FAR-CONST SIZE   =    --------     --------
  HUGE-CONST SIZE  =    --------     --------
  XHUGE-CONST SIZE =    --------     --------
  NEAR-DATA SIZE   =           4     --------
  FAR-DATA SIZE    =    --------     --------
  XHUGE-DATA SIZE  =    --------     --------
  IDATA-DATA SIZE  =    --------     --------
  SDATA-DATA SIZE  =    --------     --------
  BDATA-DATA SIZE  =    --------     --------
  HUGE-DATA SIZE   =    --------     --------
  BIT SIZE         =    --------     --------
C166 COMPILER V7.00, GPT2                                                                  04/01/2020 13:45:19 PAGE 7   

  INIT'L SIZE      =          12     --------
END OF MODULE INFORMATION.


C166 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
